<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Отчет по доставкам</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h1>Отчет по доставкам</h1>

    <canvas id="deliveriesChart" height="100"></canvas>

    <hr>

    <h2>Список доставок</h2>
    <input class="form-control mb-3" id="searchInput" placeholder="Поиск по транспорту или статусу">

    <table class="table table-bordered table-striped" id="deliveriesTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Модель</th>
          <th>Номер</th>
          <th>Отправка</th>
          <th>Прибытие</th>
          <th>Статус</th>
        </tr>
      </thead>
      <tbody>
        <!-- будет заполнено JS-ом -->
      </tbody>
    </table>
  </div>

  <script>
    // 1) Отрисуем график
    fetch("{% url 'chart_data' %}")
      .then(res => res.json())
      .then(data => {
        const labels = data.map(item => item.date);
        const counts = data.map(item => item.count);
        new Chart(document.getElementById('deliveriesChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Доставки за день',
              data: counts,
              borderColor: 'rgb(75, 192, 192)',
              tension: 0.3,
              fill: true,
              backgroundColor: 'rgba(75, 192, 192, 0.2)'
            }]
          }
        });
      });

    // 2) Подгружаем список доставок и рендерим в таблицу
    function loadDeliveries() {
      fetch("{% url 'deliveries_data' %}")
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector('#deliveriesTable tbody');
          tbody.innerHTML = '';  // очистим перед вставкой
          data.forEach(d => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${d.id}</td>
              <td>${d.model}</td>
              <td>${d.number}</td>
              <td>${d.departure}</td>
              <td>${d.arrival}</td>
              <td>${d.status}</td>
            `;
            tbody.append(row);
          });
        });
    }

    // 3) Фильтрация по вводу
    document.getElementById('searchInput').addEventListener('input', function () {
      const term = this.value.toLowerCase();
      document.querySelectorAll('#deliveriesTable tbody tr').forEach(row => {
        const match = Array.from(row.cells).some(td =>
          td.textContent.toLowerCase().includes(term)
        );
        row.style.display = match ? '' : 'none';
      });
    });

    // 4) Инициализируем всё после загрузки страницы
    document.addEventListener('DOMContentLoaded', function() {
      loadDeliveries();
    });
  </script>
</body>
</html>
